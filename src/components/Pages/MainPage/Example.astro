---
import { Code } from "astro-expressive-code/components";
---

<!-- Examples -->
<section id="examples" class="mx-auto max-w-6xl px-4 sm:px-6 py-14">
  <h2 class="text-2xl font-bold">Examples</h2>

  <div class="mt-4 grid md:grid-cols-2 gap-6">
    <Code
      title="OLTP on SSD (32 GB, 8 vCPU)"
      class="overflow-x-auto p-4"
      code={`curl -sS "${Astro.url.origin}/api/v1/tune?memory_gb=32&cpus=8&storage_type=ssd&workload=oltp&num_disks=1&num_replicas=0&db_size_gb=1&version=17&os=linux&backup_method=pg_dump"`}
      lang="shellsession"
    />
    <Code
      title="OLTP on Network Storage (128 GB, 24 vCPU)"
      class="overflow-x-auto p-4"
      code={`curl -sS "${Astro.url.origin}/api/v1/tune?memory_gb=32&cpus=8&storage_type=ssd&workload=oltp&num_disks=1&num_replicas=0&db_size_gb=1&version=17&os=linux&backup_method=pg_dump"`}
      lang="shellsession"
    />
  </div>

  <Code
    class="p-4"
    title="Ansible snippet"
    code={`- name: Fetch PG tuning
  ansible.builtin.uri:
    url: "https://api.example.com/v1/tune?\\
      memory_gb={{ ansible_memory_mb.real.total / 1024 }}&\\
      cpus={{ ansible_processor_vcpus }}&\\
      storage_type=ssd&\\
      workload={{ profile }}&\\
      num_disks={{ ansible_devices.keys() - 1 }}&\\
      num_replicas=2&\\
      db_size_gb=100&\\
      version=17&\\
      os=linux&\\
      backup_method=pg_basebackup"
    method: GET
    return_content: yes
  register: pg_tune

- name: Show warnings
  when:
    - pg_tune.json.warnings is defined
    - pg_tune.json.warnings | length > 0
  ansible.builtin.debug:
    var: pg_tune.json.warnings

- name: Write postgresql.conf overrides
  ansible.builtin.copy:
    dest: /etc/postgresql/postgresql.conf
    content: |
      {% for setting in pg_tune.json | ansible.builtin.dict2items %}
      {{ setting.key }} = {{ setting.value }}
      {% endfor %}`}
    lang="yaml"
  />
</section>
